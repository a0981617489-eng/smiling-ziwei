import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc } from 'firebase/firestore';
import { 
  Calendar, User, Clock, MessageSquare, Star, Send, Sparkles, Heart,
  Gamepad2, Lock, Check, Loader2, Share2, Instagram, AtSign, UserPlus, Layers, Dices, X, Trash2
} from 'lucide-react';

// --- ⚙️ Firebase 配置 ---
const firebaseConfig = {
  apiKey: "AIzaSyB9HsfmW3iNinFZD85XxMW9Om6valo3Nf8",
  authDomain: "smiling-ziwei.firebaseapp.com",
  projectId: "smiling-ziwei",
  storageBucket: "smiling-ziwei.firebasestorage.app",
  messagingSenderId: "447037749434",
  appId: "1:447037749434:web:b3827105adac2ecfb22a83",
  measurementId: "G-6QD9FWEEY3"
};

const appId = "smiling-ziwei-official"; 

// 初始化 Firebase 服務
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const App = () => {
  const [user, setUser] = useState(null);
  const [isAdminView, setIsAdminView] = useState(false);
  const [isAuthorized, setIsAuthorized] = useState(false);
  const [adminPassword, setAdminPassword] = useState('');
  const [bookings, setBookings] = useState([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isShareCopied, setIsShareCopied] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  
  const [formData, setFormData] = useState({
    nickname: '',
    gender: '男',
    birthDate: '',
    birthTime: '子時 (23:00-01:00)',
    service: '命盤解析',
    notes: ''
  });

  const LINE_ID = "@147twhth"; 
  const ADMIN_PASS = "8888"; 

  // 1. Firebase 驗證監聽
  useEffect(() => {
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Firebase 連線失敗:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  // 2. 資料監聽 (管理員授權後啟動)
  useEffect(() => {
    if (!user || !isAdminView || !isAuthorized) return;
    
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // 內存排序：最新優先
      setBookings(data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    }, (error) => console.error("資料獲取失敗:", error));
    
    return () => unsubscribe();
  }, [user, isAdminView, isAuthorized]);

  const services = [
    { title: "命盤解析", price: "2,000", duration: "60 分鐘", desc: "性格潛力、十年大限、當年流年。規劃未來首選！", icon: <User className="text-pink-500" />, tag: "熱門" },
    { title: "流年運勢", price: "1,000", duration: "30 分鐘", desc: "解析年度重點及月份吉凶掌握。", icon: <Calendar className="text-pink-500" />, tag: "年度" },
    { title: "單題問事", price: "600", duration: "30 分鐘", desc: "針對特定工作、感情難題提供解答。", icon: <MessageSquare className="text-pink-500" />, tag: "精準" },
    { title: "紫微牌卡", price: "500", duration: "15 分鐘", desc: "適合處理目前二選一的抉擇問題。", icon: <Dices className="text-pink-500" />, tag: "快選" }
  ];

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;
    setIsSubmitting(true);
    try {
      const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
      await addDoc(colRef, {
        ...formData,
        createdAt: serverTimestamp(),
        status: '未處理'
      });
      setSubmitSuccess(true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
      console.error("提交預約失敗:", err);
    } finally {
      setIsSubmitting(false);
    }
  };

  const copyUrl = () => {
    const dummy = document.createElement('input');
    document.body.appendChild(dummy);
    dummy.value = window.location.href;
    dummy.select();
    document.execCommand('copy');
    document.body.removeChild(dummy);
    setIsShareCopied(true);
    setTimeout(() => setIsShareCopied(false), 2000);
  };

  return (
    <div className="min-h-screen bg-[#f7d7ff] text-slate-900 font-mono">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Silkscreen:wght@400;700&display=swap');
        h1, h2 { font-family: 'Press Start 2P', cursive; line-height: 1.6; }
        body { font-family: 'Silkscreen', "Noto Sans TC", sans-serif; letter-spacing: 0.5px; }
        .pixel-card { border: 4px solid #4a1d96; box-shadow: 6px 6px 0px 0px #4a1d96; background: white; }
        .pixel-btn { border: 4px solid #000; box-shadow: 4px 4px 0px 0px #000; transition: all 0.1s; cursor: pointer; }
        .pixel-btn:active { box-shadow: 0px 0px 0px 0px #000; transform: translate(4px, 4px); }
        .pixel-grid { background-image: radial-gradient(#4a1d96 1px, transparent 1px); background-size: 20px 20px; }
      `}</style>

      {/* 導覽列 */}
      <nav className="fixed w-full bg-[#f7d7ff] border-b-4 border-purple-900 z-50 p-4 flex justify-between items-center shadow-md">
        <div className="flex items-center space-x-2">
          <Gamepad2 size={24} className="text-purple-900" />
          <span className="font-bold text-sm tracking-tighter uppercase">Smiling Ziwei</span>
        </div>
        <button onClick={() => setIsAdminView(!isAdminView)} className="text-[10px] underline font-bold uppercase tracking-tighter hover:text-pink-600 transition-colors">
          {isAdminView ? 'HOME' : 'ADMIN'}
        </button>
      </nav>

      {isAdminView ? (
        <main className="pt-24 pb-20 px-6 max-w-xl mx-auto min-h-screen">
          {!isAuthorized ? (
            <div className="pixel-card p-10 text-center mt-10 animate-in fade-in slide-in-from-bottom-4">
              <Lock className="mx-auto mb-6 text-purple-900" size={48} />
              <h2 className="text-[10px] mb-8 uppercase font-bold tracking-widest">管理員驗證 / Access Verify</h2>
              <form onSubmit={(e) => { e.preventDefault(); if (adminPassword === ADMIN_PASS) setIsAuthorized(true); else alert("密碼錯誤！"); }} className="space-y-6">
                <input 
                  type="password" 
                  value={adminPassword} 
                  onChange={(e) => setAdminPassword(e.target.value)} 
                  placeholder="請輸入密碼" 
                  className="w-full p-4 border-2 border-black text-center outline-none font-bold"
                  autoFocus
                />
                <button type="submit" className="pixel-btn w-full bg-purple-900 text-white py-4 font-bold uppercase tracking-widest">進入系統</button>
              </form>
            </div>
          ) : (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="flex justify-between items-center mb-6 border-b-4 border-purple-100 pb-4 uppercase font-bold text-[10px]">
                <h2>預約清單 ({bookings.length})</h2>
                <button onClick={() => setIsAuthorized(false)} className="bg-black text-white px-3 py-1">Logout</button>
              </div>
              {bookings.length === 0 && <div className="text-center py-20 opacity-30 uppercase text-xs">目前無預約資料</div>}
              {bookings.map(b => (
                <div key={b.id} className="pixel-card p-4 text-[10px] font-bold space-y-2 relative">
                  <div className="flex justify-between">
                    <span className="text-purple-900 uppercase">{b.nickname} ({b.gender})</span>
                    <span className={`border px-1 uppercase ${b.status === '已處理' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-pink-50 text-pink-600 border-pink-200'}`}>
                      {b.status || '未處理'}
                    </span>
                  </div>
                  <div className="opacity-60 space-y-1">
                    <p>項目：{b.service}</p>
                    <p>生日：{b.birthDate} ({b.birthTime})</p>
                  </div>
                  {b.notes && <p className="bg-stone-50 p-2 border-l-2 border-purple-200 italic opacity-70">備註：{b.notes}</p>}
                  <div className="flex justify-end pt-2 gap-2">
                    <button 
                      onClick={async () => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', b.id);
                        await updateDoc(ref, { status: b.status === '已處理' ? '未處理' : '已處理' });
                      }}
                      className="text-purple-600 underline uppercase text-[8px]"
                    >
                      切換狀態
                    </button>
                    <button 
                      onClick={() => window.confirm('確定刪除此資料？') && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', b.id))}
                      className="text-red-500 underline uppercase text-[8px]"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </main>
      ) : (
        <div className="pt-24 pb-20 px-6 max-w-xl mx-auto pixel-grid min-h-screen">
          <section className="pixel-card p-8 mb-12 text-center bg-white uppercase shadow-lg">
            <h1 className="text-xl md:text-2xl mb-6 text-purple-900 tracking-tighter uppercase font-bold">人類世界<br/><span className="text-pink-600">攻略小魔法</span></h1>
            <div className="inline-block bg-pink-100 text-pink-600 text-[10px] px-3 py-1 mb-6 font-bold uppercase tracking-widest border border-pink-600">STATUS: READY</div>
            <p className="text-[10px] opacity-60 leading-relaxed uppercase tracking-tighter mb-8 italic">瞇著眼就能突破未知關卡</p>
            <div className="flex justify-center space-x-4">
              <button onClick={copyUrl} className="pixel-btn bg-white p-3 flex items-center justify-center space-x-2">
                {isShareCopied ? <Check size={16} className="text-green-500" /> : <Share2 size={16} />}
                <span className="text-[10px] font-bold uppercase">{isShareCopied ? 'COPIED' : 'SHARE WEB'}</span>
              </button>
            </div>
          </section>

          {!submitSuccess ? (
            <form onSubmit={handleSubmit} className="pixel-card p-6 space-y-8 bg-white shadow-xl uppercase animate-in fade-in slide-in-from-bottom-8 duration-500">
              <div className="text-center border-b-2 border-dashed border-purple-100 pb-4 font-bold uppercase">
                <h2 className="text-[10px] tracking-widest font-bold">角色登錄 / Registration</h2>
              </div>
              
              <div className="space-y-6 text-[10px] font-bold uppercase">
                <div className="space-y-2">
                  <label className="block text-purple-900">暱稱 / Nickname</label>
                  <input required placeholder="..." className="w-full p-4 border-2 border-black focus:bg-pink-50 outline-none transition-all" onChange={e => setFormData({...formData, nickname: e.target.value})} />
                </div>

                <div className="flex gap-4">
                   <div className="flex-1 space-y-2">
                     <label className="block text-purple-900">性別 / Gender</label>
                     <select className="w-full p-4 border-2 border-black bg-white outline-none" onChange={e => setFormData({...formData, gender: e.target.value})}>
                       <option>男</option><option>女</option>
                     </select>
                   </div>
                </div>

                <div className="space-y-2">
                  <label className="block text-purple-900">國曆生日 / Birthday</label>
                  <input required type="date" className="w-full p-4 border-2 border-black outline-none" onChange={e => setFormData({...formData, birthDate: e.target.value})} />
                </div>

                <div className="space-y-2">
                  <label className="block text-purple-900">出生時辰 / Time</label>
                  <select className="w-full p-4 border-2 border-black bg-white outline-none" onChange={e => setFormData({...formData, birthTime: e.target.value})}>
                    <option>子時 (23-01)</option><option>丑時 (01-03)</option><option>寅時 (03-05)</option>
                    <option>卯時 (05-07)</option><option>辰時 (07-09)</option><option>巳時 (09-11)</option>
                    <option>午時 (11-13)</option><option>未時 (13-15)</option><option>申時 (15-17)</option>
                    <option>酉時 (17-19)</option><option>戌時 (19-21)</option><option>亥時 (21-23)</option>
                  </select>
                </div>

                <div className="space-y-2">
                  <label className="block text-purple-900">預約項目 / Service</label>
                  <select className="w-full p-4 border-2 border-black bg-white outline-none" onChange={e => setFormData({...formData, service: e.target.value})}>
                    {services.map(s => <option key={s.title}>{s.title}</option>)}
                  </select>
                </div>

                <div className="space-y-2">
                  <label className="block text-purple-900">備註事項 / Notes</label>
                  <textarea placeholder="現狀簡述..." className="w-full p-4 border-2 border-black outline-none h-24 focus:bg-pink-50 resize-none" onChange={e => setFormData({...formData, notes: e.target.value})} />
                </div>
              </div>

              <button type="submit" disabled={isSubmitting} className="pixel-btn w-full bg-pink-500 text-white p-5 font-bold uppercase tracking-widest flex items-center justify-center space-x-2">
                {isSubmitting ? <Loader2 className="animate-spin" /> : <><span>確認預約 / START ADVENTURE</span><Sparkles size={16}/></>}
              </button>
            </form>
          ) : (
            <div className="pixel-card p-12 text-center bg-white space-y-8 animate-in fade-in zoom-in-95 duration-500 uppercase">
              <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto border-4 border-green-600 shadow-sm">
                <Check size={48} />
              </div>
              <h2 className="text-lg text-purple-900 tracking-tighter uppercase font-bold">預約成功！<br/>MISSION COMPLETE</h2>
              <p className="text-[10px] opacity-60 tracking-widest leading-relaxed">
                預約資料已送達。<br/>請點擊按鈕前往 LINE 完成聯繫。
              </p>
              <button 
                onClick={() => window.open(`https://line.me/R/ti/p/${LINE_ID}`)} 
                className="pixel-btn bg-[#06c755] text-white p-5 w-full font-bold uppercase tracking-widest shadow-lg flex items-center justify-center space-x-2"
              >
                <span>OPEN LINE / 聯繫老師</span>
              </button>
              <button onClick={() => setSubmitSuccess(false)} className="text-[8px] underline opacity-30 block mx-auto font-bold uppercase">返回修改資料</button>
            </div>
          )}
        </div>
      )}

      <footer className="py-12 text-center opacity-30 text-[8px] font-bold uppercase tracking-widest flex flex-col items-center space-y-4">
        <div className="flex space-x-4">
           <Instagram size={16} />
           <AtSign size={16} />
           <UserPlus size={16} />
        </div>
        <p>© 2026 SMILING ZIWEI STUDIO | LEVEL UP YOUR SOUL</p>
      </footer>
    </div>
  );
};

export default App;